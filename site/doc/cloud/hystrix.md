## Hystrix
Hystrix 提供了资源隔离、降级、熔断、缓存等功能。

- 资源隔离：包括线程池隔离和信号量隔离，限制调用分布式服务的资源使用，某一个调用的服务出现问题不会影响其他服务的调用
- 降级：包括超时降级和资源不足降级，降级后可以配合降级接口返回兜底数据
- 熔断：当失败率达到阈值时自动触发降级，熔断器触发的快熟失败会进行快速恢复
- 缓存：返回结果可以缓存，之后的请求调用从缓存中获取结果

### 资源隔离
Hystrix 提供了两种资源隔离的方式：线程池隔离模式和信号量隔离模式。

线程池隔离模式使用一个线程池来存储当前的请求，堆积的请求先进入线程池队列，这种方式需要为每个依赖的服务申请一个线程池，有一定的资源消耗，但是可以应对突发流量。

信号量隔离模式使用一个原子计数器记录当前有多少个线程在运行，请求到来时先判断计数器的数值，如果超过设置的最大线程个数则丢弃该请求，否则处理请求并将计数器 +1。

#### 降级
服务降级可以在资源不足或者以来服务超时时返回降级数据。Hystrix 提供了三种降级方式：快速模式、故障转移、主次模式。

快速模式时如果调用服务失败则立即返回失败。

故障转移时如果服务调用失败则调用降级服务，如果都失败可以从默认缓存中返回数据。

主次模式时当服务调用有多中实现时可以设置切换。


#### 熔断







 Hystrix 调用原理：
 - 判断是否开启请求缓存，如果开启且能查找到对应缓存则直接返回缓存
 - 检查是否开启了断路器，如果开启断路器且断路器被打开(依赖服务异常)，则不会调用 command 而是调用 getFallback 方法降级
 - 如果这个 command 线程池和队列已满，或者 semaphore 信号量已满，那么也不会执行 command，而是直接去调用 fallback 降级机制
 - HystrixObservableCommand 对象的 construct() 方法，或者 HystrixCommand 的 run() 方法来实际执行这个 command

短路器
 - Hystrix 会把每一个依赖服务的调用成功、失败、Reject、Timeout 等事件发送给 circuit breaker 断路器。
 - 断路器就会对这些事件的次数进行统计，根据异常事件发生的比例来决定是否要进行断路（熔断）。如果打开了断路器，那么在接下来一段时间内，会直接断路，返回降级结果。
 - 如果在之后，断路器尝试执行 command，调用没有出错，返回了正常结果，那么 Hystrix 就会把断路器关闭。